<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Property Details - Nirvana Estates</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background-color: #f9fafb; }

  /* ---------- Carousel / Gallery ---------- */
  .carousel { display: flex; overflow-x: auto; gap: 1rem; padding: 0.5rem 0; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; cursor: grab; }
  .carousel:active { cursor: grabbing; }
  .carousel::-webkit-scrollbar { display: none; }

  .carousel-item { flex: 0 0 auto; scroll-snap-align: start; border-radius: 0.75rem; overflow: hidden; background: #000; display: flex; justify-content: center; align-items: center; width: 250px; height: 400px; }
  @media(min-width:768px){ .carousel-item { width: 300px; height: 400px; } }
  @media(min-width:1024px){ .carousel-item { width: 350px; height: 420px; } }

  .media-wrapper { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
  .short-media { width: 100%; height: 100%; object-fit: contain; border-radius: 0.75rem; transition: transform .3s; }
  .short-media:hover { transform: scale(1.02); }

  /* ---------- Info grid ---------- */
  .info-card { background: #fff; border-radius: 1rem; padding: 1rem; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
  .info-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 1rem; }
  @media(min-width:1024px){ .info-grid { grid-template-columns: repeat(3,1fr); } }
  .info-grid div span { font-weight: 600; }

  /* ---------- CTA Buttons ---------- */
  .cta-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; }
  .cta-call { background-color: #0f2b3d; color: #fff; }
  .cta-call:hover { background-color: #15425c; }
  .cta-wa { background-color: #22c55e; color: #fff; }
  .cta-wa:hover { background-color: #16a34a; }

  .floating-call { position: fixed; bottom: 1rem; right: 1rem; background-color: #0f2b3d; color: #fff; padding: 0.75rem 1rem; border-radius: 9999px; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,.2); z-index: 50; transition: background 0.2s; }
  .floating-call:hover { background-color: #15425c; }

  .prose { max-width: 100%; line-height: 1.6; }

</style>
</head>
<body class="text-gray-800">

<!-- Header -->
<div id="header-placeholder"></div>
<script>
fetch('header_main.html')
  .then(res=>res.text())
  .then(data=>document.getElementById('header-placeholder').innerHTML=data)
  .catch(err=>console.error(err));
</script>

<main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

  <!-- Gallery -->
  <section id="gallery"></section>

  <!-- Title & Price -->
  <section class="space-y-3">
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-end gap-2">
      <h2 id="property-title" class="text-2xl md:text-3xl font-bold">Property Title</h2>
      <span id="property-price" class="text-[#0f2b3d] font-extrabold text-xl md:text-2xl"></span>
    </div>
  </section>

  <!-- Info Grid -->
  <section class="info-card">
    <div class="info-grid" id="info-grid"></div>
  </section>

  <!-- Description -->
  <section class="prose prose-sm max-w-none text-gray-800">
    <h3 class="text-lg font-semibold mb-2">Description</h3>
    <div id="property-desc"></div>
  </section>

  <!-- CTA Buttons -->
  <section class="flex flex-wrap gap-4">
    <a id="call-btn" class="cta-btn cta-call" href="#">Call Now</a>
    <a id="wa-btn" class="cta-btn cta-wa" href="#" target="_blank">WhatsApp</a>
  </section>

</main>

<!-- Floating Call Button -->
<a href="tel:+917039199717" class="floating-call">ðŸ“ž Call Now</a>

<script>
const INR=new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'});

function fixMediaUrl(src){ return src.startsWith('http')?src:`https://nirvana-estates-backend.onrender.com/${src.replace(/^\/+/,'')}`; }

function createSlide(src,type){
  const wrapper=document.createElement('div'); wrapper.className='carousel-item';
  const mediaWrap=document.createElement('div'); mediaWrap.className='media-wrapper';

  if(type==='image'){
    const img=new Image(); img.src=fixMediaUrl(src); img.className='short-media'; mediaWrap.appendChild(img);
  } else {
    if(src.includes('youtube.com')||src.includes('youtu.be')){
      let vidId=''; if(src.includes('shorts/')) vidId=src.split('shorts/')[1].split('?')[0];
      else if(src.includes('youtu.be/')) vidId=src.split('youtu.be/')[1].split('?')[0];
      else if(src.includes('watch?v=')) vidId=src.split('watch?v=')[1].split('&')[0];
      const iframe=document.createElement('iframe');
      iframe.src=`https://www.youtube-nocookie.com/embed/${vidId}?rel=0`;
      iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen=true; iframe.className='short-media'; mediaWrap.appendChild(iframe);
    } else {
      const vid=document.createElement('video'); vid.src=fixMediaUrl(src); vid.preload='metadata';
      vid.muted=true; vid.playsInline=true; vid.controls=true; vid.className='short-media'; mediaWrap.appendChild(vid);
    }
  }

  wrapper.appendChild(mediaWrap); return wrapper;
}

function renderDescription(desc){
  if(!desc) return '';
  const lines=desc.split(/\r?\n/); let html='', inList=false;
  lines.forEach(line=>{
    const t=line.trim();
    if(!t){ if(inList){ html+='</ul>'; inList=false; } return; }
    const isBullet=/^[-*â€¢]\s+/.test(t);
    if(isBullet){ if(!inList){ html+='<ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">'; inList=true; }
      html+=`<li>${t.replace(/^[-*â€¢]\s+/,'')}</li>`;
    } else { if(inList){ html+='</ul>'; inList=false; } html+=`<p class="text-sm text-gray-700 mb-2">${t}</p>`; }
  });
  if(inList) html+='</ul>'; return html;
}

async function loadDetails(){
  const id=new URLSearchParams(location.search).get('id');
  if(!id){ document.getElementById('gallery').innerHTML='<p class="text-red-600">Invalid property ID.</p>'; return; }

  try{
    const res=await fetch('https://nirvana-estates-backend.onrender.com/api/properties');
    if(!res.ok) throw new Error('API failed');
    const all=await res.json(); const p=all.find(x=>String(x._id)===String(id));
    if(!p){ document.getElementById('gallery').innerHTML='<p class="text-red-600">Property not found.</p>'; return; }

    // ---------- Gallery ----------
    const gallery=document.getElementById('gallery'); gallery.innerHTML='';
    const track=document.createElement('div'); track.className='carousel';
    const media=[...(p.images||[]).map(s=>({src:s,type:'image'})), ...(p.videos||[]).map(s=>({src:s,type:'video'}))];
    if(media.length) media.forEach(m=>track.appendChild(createSlide(m.src,m.type)));
    else { const ph=document.createElement('div'); ph.className='w-full h-64 flex items-center justify-center bg-gray-200 text-gray-500 rounded'; ph.textContent='No media available'; track.appendChild(ph); }
    gallery.appendChild(track);

    // ---------- Title & Price ----------
    document.getElementById('property-title').textContent=p.title||'Property';
    const priceEl=document.getElementById('property-price');
    if(p.price && Number(p.price)>0){ priceEl.textContent=INR.format(p.price); priceEl.classList.remove('hidden'); } 
    else{ priceEl.textContent=''; priceEl.classList.add('hidden'); }

    // ---------- Info Grid ----------
    const infoGrid=document.getElementById('info-grid'); infoGrid.innerHTML='';
    const cell=(label,value)=>{ const d=document.createElement('div'); d.innerHTML=`<span>${label}:</span> ${value}`; return d; };
    if(p.bedrooms) infoGrid.appendChild(cell('Bedrooms',p.bedrooms));
    if(p.bathrooms) infoGrid.appendChild(cell('Bathrooms',p.bathrooms));
    if(p.carpetArea) infoGrid.appendChild(cell('Carpet Area',`${p.carpetArea} sq ft`));
    if(p.builtupArea) infoGrid.appendChild(cell('Built-up Area',`${p.builtupArea} sq ft`));
    if(p.location) infoGrid.appendChild(cell('Location',p.location));
    if(p.category) infoGrid.appendChild(cell('Category',p.category));

    // ---------- Description ----------
    document.getElementById('property-desc').innerHTML=p.description?renderDescription(p.description):'<p class="text-sm text-gray-500">No description provided.</p>';

    // ---------- CTA ----------
    document.getElementById('call-btn').href='tel:+917039199717';
    document.getElementById('wa-btn').href='https://wa.me/917039199717?text='+encodeURIComponent(`I am interested in property: ${p.title||p._id}`);

  }catch(e){ console.error(e); document.getElementById('gallery').innerHTML='<p class="text-red-600">Failed to load property details.</p>'; }
}

loadDetails();
</script>

<!-- Footer -->
<div class="bg-[#0f2b3d] text-gray-300 text-center text-sm py-4">
  Â© <span id="year"></span> Nirvana Estates. All rights reserved.
</div>
<script>document.getElementById('year').textContent=new Date().getFullYear();</script>
</body>
</html>
